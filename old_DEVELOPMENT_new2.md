# DEVELOPMENT.md

## ğŸ“‹ ê³¼ì œ ìš”êµ¬ì‚¬í•­

### í•„ìˆ˜ êµ¬í˜„ ì‚¬í•­

  * [cite\_start]**ê³„ì¸µì  ì‚¬ê°í˜• êµ¬ì¡°:** íŒŒë€ìƒ‰(ë¶€ëª¨) â†’ ì£¼í™©ìƒ‰(ìì‹) â†’ ë³´ë¼ìƒ‰(ì†ì)ì˜ 3ê°œ ì‚¬ê°í˜•ì„ ë Œë”ë§í•˜ë©°, ëª¨ë‘ `1px` ê²€ì€ í…Œë‘ë¦¬ë¥¼ ê°€ì§‘ë‹ˆë‹¤[cite: 10, 11].
  * **Edge ê¸°ë°˜ ìƒí˜¸ì‘ìš©:**
      * [cite\_start]ì‚¬ê°í˜•ì˜ **ëª¨ì„œë¦¬ `10px`** ì•ˆìª½ ì˜ì—­ì—ì„œë§Œ í˜¸ë²„ ë° ì„ íƒì´ ê°€ëŠ¥í•©ë‹ˆë‹¤[cite: 31, 32, 35].
      * [cite\_start]í˜¸ë²„ ì‹œ í…Œë‘ë¦¬ê°€ `3px`ë¡œ ë³€ê²½ë©ë‹ˆë‹¤[cite: 33].
  * **ì„ íƒ ì‹œìŠ¤í…œ:**
      * [cite\_start]ì„ íƒëœ ì‚¬ê°í˜•ì˜ í…Œë‘ë¦¬ëŠ” `3px`ë¡œ ë³€ê²½ë©ë‹ˆë‹¤[cite: 23].
      * ê²¹ì¹˜ëŠ” ì˜ì—­ì—ì„œëŠ” ë Œë”ë§ ìˆœì„œ(z-index)ê°€ ê°€ì¥ ë†’ì€ ê°ì²´ê°€ ìš°ì„ ì ìœ¼ë¡œ ì„ íƒë©ë‹ˆë‹¤.
      * ìº”ë²„ìŠ¤ì˜ ë¹ˆ ê³µê°„ì„ í´ë¦­í•˜ë©´ í˜„ì¬ ì„ íƒì´ í•´ì œë©ë‹ˆë‹¤.
  * [cite\_start]**ê³„ì¸µì  ì´ë™:** ë¶€ëª¨ ì‚¬ê°í˜• ì´ë™ ì‹œ ëª¨ë“  ìì‹ ì‚¬ê°í˜•ì´ í•¨ê»˜ ì´ë™í•©ë‹ˆë‹¤[cite: 12, 17].
  * [cite\_start]**ì´ë™ ì œì•½ ì¡°ê±´:** ìì‹ ì‚¬ê°í˜•ì€ ë¶€ëª¨ ì‚¬ê°í˜•ì˜ ê²½ê³„ë¥¼ ë²—ì–´ë‚  ìˆ˜ ì—†ìŠµë‹ˆë‹¤[cite: 19, 22].
  * **ë¦¬ì‚¬ì´ì¦ˆ ê¸°ëŠ¥:**
      * [cite\_start]ì„ íƒëœ ì‚¬ê°í˜•ì—ë§Œ ë¦¬ì‚¬ì´ì¦ˆ í•¸ë“¤ì´ í‘œì‹œë˜ë©° í¬ê¸° ì¡°ì ˆì´ ê°€ëŠ¥í•©ë‹ˆë‹¤[cite: 25, 28].
      * [cite\_start]ë¶€ëª¨ í¬ê¸°ê°€ ë³€ê²½ë˜ì–´ë„ ìì‹ì˜ í¬ê¸°ëŠ” ìœ ì§€ë©ë‹ˆë‹¤[cite: 27].
      * [cite\_start]**ë¦¬ì‚¬ì´ì¦ˆ ì œì•½ ì¡°ê±´:** ë¶€ëª¨ë³´ë‹¤ ì»¤ì§ˆ ìˆ˜ ì—†ìœ¼ë©°, \*\*ëª¨ë“  ì§ê³„ ìì‹ë“¤ì„ ê°ì‹¸ëŠ” ìµœì†Œ ê²½ê³„ ìƒì(Bounding Box)\*\*ë³´ë‹¤ ì‘ì•„ì§ˆ ìˆ˜ ì—†ìŠµë‹ˆë‹¤[cite: 29].
  * **ë“œë˜ê·¸ ì„ íƒ:**
      * [cite\_start]ë“œë˜ê·¸í•˜ì—¬ ìƒì„±ëœ ì„ íƒ ì˜ì—­ ì•ˆì— ì‚¬ê°í˜•ì˜ **ë„¤ ê¼­ì§“ì ì´ ëª¨ë‘ í¬í•¨ë˜ë©´** í•´ë‹¹ ì‚¬ê°í˜•ì„ ì„ íƒ í›„ë³´ë¡œ ì§€ì •í•©ë‹ˆë‹¤[cite: 36, 37].
      * [cite\_start]ì„ íƒ í›„ë³´ ì¤‘ ê°€ì¥ ìƒìœ„ ë¶€ëª¨ê°€ ìµœì¢… ì„ íƒë©ë‹ˆë‹¤[cite: 38].
  * **ì‚¬ìš©ì í”¼ë“œë°± (ì»¤ì„œ):** ìƒí˜¸ì‘ìš© ìƒíƒœì— ë”°ë¼ ë§ˆìš°ìŠ¤ ì»¤ì„œ ëª¨ì–‘ì´ ë³€ê²½ë˜ì–´ì•¼ í•©ë‹ˆë‹¤.

### ê¸°ìˆ  ìŠ¤íƒ

  * **ëŸ°íƒ€ì„**: Bun
  * [cite\_start]**í”„ë ˆì„ì›Œí¬**: React + TypeScript [cite: 40]
  * [cite\_start]**ìº”ë²„ìŠ¤**: Fabric.js [cite: 40]
  * **ë¹Œë“œ ë„êµ¬**: Vite

-----

## ğŸ— ê¸°ìˆ  ì•„í‚¤í…ì²˜

### ë°ì´í„° êµ¬ì¡° ì„¤ê³„ (`HierarchicalElement`)

```typescript
interface HierarchicalElement {
  id: string;
  type: 'rectangle';
  parentId?: string;
  childIds: string[];
  depth: number;
  position: { x: number; y: number };
  size: { width: number; height: number };
  style: {
    fill: string;
    stroke: string;
    strokeWidth: number;
  };
  selected: boolean;
  hovered: boolean;
  constraints: {
    stayWithinParent: boolean;
    minSize: { width: number; height: number };
    maxSize: { width: number; height: number };
  };
  fabricObject?: fabric.Rect;
}
```

### í•µì‹¬ ì‹œìŠ¤í…œ

#### 1\. `HierarchyManager` - íŠ¸ë¦¬ ë°ì´í„° ê´€ë¦¬

```typescript
class HierarchyManager {
  private elements = new Map<string, HierarchicalElement>();

  createElement(id: string, parentId: string | null, props: Partial<HierarchicalElement>): HierarchicalElement {
    // ... id, parentId, depth ë“± ê³„ì¸µ ì •ë³´ ì„¤ì • í›„ elements.set() ...
  }

  getElement(id: string): HierarchicalElement | undefined {
    return this.elements.get(id);
  }

  getAllElements(): IterableIterator<HierarchicalElement> {
    return this.elements.values();
  }

  getParent(id: string): HierarchicalElement | null {
    // ... parentIdë¡œ ë¶€ëª¨ íƒìƒ‰ ...
  }
  
  getChildren(id: string): HierarchicalElement[] {
    // ... childIdsë¡œ ìì‹ë“¤ íƒìƒ‰ ...
  }
  
  getDescendants(id: string): HierarchicalElement[] {
    // ... ì¬ê·€ì ìœ¼ë¡œ ëª¨ë“  í›„ì† íƒìƒ‰ ...
  }

  updateElementPosition(id: string, x: number, y: number): void {
    const el = this.getElement(id);
    if (el) el.position = { x, y };
  }
  
  updateElementSize(id: string, width: number, height: number): void {
    const el = this.getElement(id);
    if (el) el.size = { width, height };
  }

  updateElementState(id: string, state: Partial<{ selected: boolean; hovered: boolean }>): void {
    const el = this.getElement(id);
    // ... selected, hovered ìƒíƒœ ì—…ë°ì´íŠ¸ ...
  }
}
```

#### 2\. `EdgeDetector` - ëª¨ì„œë¦¬ ê°ì§€

```typescript
class EdgeDetector {
  private readonly EDGE_THRESHOLD = 10;

  isPointOnEdge(x: number, y: number, element: HierarchicalElement): boolean {
    const { position, size } = element;
    const { x: rectX, y: rectY } = position;
    const { width, height } = size;

    const isInside = x >= rectX && x <= rectX + width && y >= rectY && y <= rectY + height;
    if (!isInside) return false;

    const isOutsideInnerBox = 
      x < rectX + this.EDGE_THRESHOLD ||
      x > rectX + width - this.EDGE_THRESHOLD ||
      y < rectY + this.EDGE_THRESHOLD ||
      y > rectY + height - this.EDGE_THRESHOLD;

    return isOutsideInnerBox;
  }
}
```

#### 3\. `SelectionManager` - ì„ íƒ ë¡œì§ ê´€ë¦¬

```typescript
class SelectionManager {
  private selectedElementId: string | null = null;

  constructor(
    private hierarchyManager: HierarchyManager,
    private edgeDetector: EdgeDetector,
  ) {}

  getSelectedElement(): HierarchicalElement | null {
    // ... selectedElementIdë¡œ ìš”ì†Œ ë°˜í™˜ ...
  }

  selectAtPoint(x: number, y: number, allElements: HierarchicalElement[]): HierarchicalElement | null {
    // 1. z-index(ë Œë”ë§ ìˆœì„œ) ì—­ìˆœìœ¼ë¡œ ì •ë ¬ëœ ìš”ì†Œë“¤ ìˆœíšŒ
    // 2. EdgeDetectorë¡œ í´ë¦­ ê°€ëŠ¥í•œ ìš”ì†Œ(í›„ë³´) ì°¾ê¸°
    const candidate = allElements.find(el => this.edgeDetector.isPointOnEdge(x, y, el));

    // 3. ê¸°ì¡´ ì„ íƒ í•´ì œ ë° ì‹ ê·œ ì„ íƒ ì²˜ë¦¬
    this.deselectAll();
    if (candidate) {
      this.selectedElementId = candidate.id;
      this.hierarchyManager.updateElementState(candidate.id, { selected: true });
      return candidate;
    }
    return null;
  }

  selectByDrag(selectionRect: { left, top, width, height }): HierarchicalElement | null {
    const containedElements = [];
    // 1. ëª¨ë“  ìš”ì†Œ ìˆœíšŒí•˜ë©° ë„¤ ê¼­ì§“ì ì´ selectionRect ì•ˆì— ì™„ì „íˆ í¬í•¨ë˜ëŠ”ì§€ í™•ì¸
    // 2. í¬í•¨ëœ ìš”ì†Œ(í›„ë³´)ë“¤ ì¤‘ depthê°€ ê°€ì¥ ë‚®ì€ ìµœìƒìœ„ ë¶€ëª¨ ì°¾ê¸°
    // 3. ê¸°ì¡´ ì„ íƒ í•´ì œ ë° ì‹ ê·œ ì„ íƒ ì²˜ë¦¬
    // ...
  }

  handleHover(x: number, y: number, allElements: HierarchicalElement[]): HierarchicalElement | null {
    // 1. ëª¨ë“  ìš”ì†Œì˜ hovered ìƒíƒœ ì´ˆê¸°í™”
    // 2. z-index ì—­ìˆœìœ¼ë¡œ ìˆœíšŒí•˜ë©° hoverëœ ìš”ì†Œ ì°¾ê¸°
    // 3. í•´ë‹¹ ìš”ì†Œì˜ hovered ìƒíƒœë¥¼ trueë¡œ ë³€ê²½í•˜ê³  ë°˜í™˜
    // ...
  }
  
  deselectAll(): void {
    if (this.selectedElementId) {
      this.hierarchyManager.updateElementState(this.selectedElementId, { selected: false });
    }
    this.selectedElementId = null;
  }
}
```

#### 4\. `TransformManager` - ë³€í™˜ ë° ì œì•½ ì¡°ê±´ ê´€ë¦¬

```typescript
class TransformManager {
  constructor(private hierarchyManager: HierarchyManager) {}

  moveElementWithChildren(id: string, deltaX: number, deltaY: number): void {
    const element = this.hierarchyManager.getElement(id);
    if (!element) return;

    // 1. ì´ë™ ì œì•½ ì¡°ê±´ ì ìš©í•˜ì—¬ ì‹¤ì œ ì´ë™í•  delta ê³„ì‚°
    const constrainedDelta = this.applyMovementConstraints(element, deltaX, deltaY);

    // 2. ìì‹ ê³¼ ëª¨ë“  ìì†ë“¤ì—ê²Œ ë™ì¼í•œ deltaë¥¼ ì¬ê·€ì ìœ¼ë¡œ ì ìš©
    const descendants = this.hierarchyManager.getDescendants(id);
    [element, ...descendants].forEach(el => {
      const newPos = { x: el.position.x + constrainedDelta.x, y: el.position.y + constrainedDelta.y };
      this.hierarchyManager.updateElementPosition(el.id, newPos.x, newPos.y);
    });
  }

  resizeElement(id: string, newWidth: number, newHeight: number): void {
    // 1. ë¦¬ì‚¬ì´ì¦ˆ ì œì•½ ì¡°ê±´(ë¶€ëª¨ ê²½ê³„, ìì‹ ê²½ê³„ ìƒì)ì— ë”°ë¼ ìµœì¢… í¬ê¸° ê³„ì‚°
    // 2. hierarchyManager.updateElementSize()ë¡œ í¬ê¸° ì—…ë°ì´íŠ¸
    // ...
  }

  private applyMovementConstraints(element: HierarchicalElement, deltaX: number, deltaY: number): { x, y } {
    // ... ë¶€ëª¨ ê²½ê³„ ë‚´ì—ì„œë§Œ ì´ë™í•˜ë„ë¡ deltaX, deltaY ê³„ì‚° ...
  }
  
  private applyResizeConstraints(element: HierarchicalElement, newWidth: number, newHeight: number): { width, height } {
    // ... ë¶€ëª¨ ê²½ê³„ ë° ìì‹ ê²½ê³„ ìƒì ì¡°ê±´ì— ë§ëŠ” ìµœì¢… í¬ê¸° ê³„ì‚° ...
  }
}
```

-----

## ğŸ¨ ë©”ì¸ React ì»´í¬ë„ŒíŠ¸ (`CanvasEditor.tsx`)

```typescript
import React, { useRef, useEffect, useState, useCallback } from 'react';
import { fabric } from 'fabric';
// ... Manager í´ë˜ìŠ¤ë“¤ import

export const CanvasEditor: React.FC = () => {
  const canvasRef = useRef<HTMLCanvasElement>(null);
  const [managers, setManagers] = useState<{...}>();
  // ... isDragging, dragStart ë“± ìƒí˜¸ì‘ìš© ìƒíƒœ ê´€ë¦¬ ...

  // ë°ì´í„° ëª¨ë¸ì„ Fabric ìº”ë²„ìŠ¤ì— ë Œë”ë§í•˜ëŠ” í•¨ìˆ˜
  const renderHierarchy = useCallback((hierarchy: HierarchyManager, fabricCanvas: fabric.Canvas) => {
    // 1. HierarchyManagerì˜ ëª¨ë“  ìš”ì†Œë¥¼ ê°€ì ¸ì˜´
    // 2. ê° ìš”ì†Œì— ëŒ€í•´ fabricObjectê°€ ìˆìœ¼ë©´ ì†ì„± ì—…ë°ì´íŠ¸, ì—†ìœ¼ë©´ ìƒˆë¡œ ìƒì„±í•˜ì—¬ ì¶”ê°€
    // 3. selected, hovered ìƒíƒœì— ë”°ë¼ stroke, strokeWidth, hasControls ë“± ì—…ë°ì´íŠ¸
    // 4. fabricCanvas.renderAll() í˜¸ì¶œ
  }, []);

  // ì´ˆê¸°í™”
  useEffect(() => {
    // ... ìº”ë²„ìŠ¤ ë° ë§¤ë‹ˆì € ì´ˆê¸°í™” ...
    // ... ì´ˆê¸° ì‚¬ê°í˜• ë°ì´í„° ìƒì„± ...
    // ... ì´ë²¤íŠ¸ í•¸ë“¤ëŸ¬ ì„¤ì • ...
  }, []);

  // ì´ë²¤íŠ¸ í•¸ë“¤ëŸ¬ ì„¤ì • í•¨ìˆ˜
  const setupEventHandlers = (fabricCanvas, managers) => {
    let isDragging = false;
    let isDragSelecting = false;
    let dragStart = null;
    let selectionRect = null; // ë“œë˜ê·¸ ì„ íƒìš© ì‚¬ê°í˜•

    fabricCanvas.on('mouse:down', (event) => {
      const pointer = fabricCanvas.getPointer(event.e);
      const allElements = Array.from(managers.hierarchy.getAllElements())
          .sort((a,b) => b.depth - a.depth); // z-index ê³ ë ¤
      
      const target = managers.selection.selectAtPoint(pointer.x, pointer.y, allElements);
      
      if (target) {
        isDragging = true;
      } else {
        managers.selection.deselectAll();
        isDragSelecting = true;
        // ... selectionRect ìƒì„± ë° ìº”ë²„ìŠ¤ì— ì¶”ê°€ ...
      }
      dragStart = pointer;
      renderHierarchy(managers.hierarchy, fabricCanvas);
    });
    
    fabricCanvas.on('mouse:move', (event) => {
      const pointer = fabricCanvas.getPointer(event.e);
      // ... ì»¤ì„œ ëª¨ì–‘ ê¸°ë³¸ê°’ìœ¼ë¡œ ì´ˆê¸°í™” ...

      if (isDragging) {
        const selected = managers.selection.getSelectedElement();
        // ... ì»¤ì„œë¥¼ 'move'ë¡œ ë³€ê²½ ...
        // ... TransformManager.moveElementWithChildren í˜¸ì¶œ ...
      } else if (isDragSelecting) {
        // ... ì»¤ì„œë¥¼ 'crosshair'ë¡œ ë³€ê²½ ...
        // ... selectionRect í¬ê¸° ì—…ë°ì´íŠ¸ ...
      } else {
        const hovered = managers.selection.handleHover(pointer.x, pointer.y, allElements);
        if (hovered) { // ... ì»¤ì„œë¥¼ 'move'ë¡œ ë³€ê²½ ... }
      }
      renderHierarchy(managers.hierarchy, fabricCanvas);
    });

    fabricCanvas.on('mouse:up', () => {
      if (isDragSelecting) {
        managers.selection.selectByDrag(selectionRect);
      }
      isDragging = false;
      isDragSelecting = false;
      dragStart = null;
      // ... selectionRect ì œê±° ...
      renderHierarchy(managers.hierarchy, fabricCanvas);
    });
    
    fabricCanvas.on('object:scaling', (event) => {
        // ... TransformManager.resizeElement í˜¸ì¶œí•˜ì—¬ ì œì•½ì¡°ê±´ ì ìš© ...
        // ... Fabric ê°ì²´ ìŠ¤ì¼€ì¼ ì´ˆê¸°í™” ë° í¬ê¸° ì¬ì„¤ì • ...
    });
  };

  return (
    // ... JSX í…œí”Œë¦¿ ...
  );
};
```